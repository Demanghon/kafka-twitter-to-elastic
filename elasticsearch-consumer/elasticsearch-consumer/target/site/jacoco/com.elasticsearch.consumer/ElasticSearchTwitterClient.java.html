<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ElasticSearchTwitterClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">elasticsearch-consumer</a> &gt; <a href="index.source.html" class="el_package">com.elasticsearch.consumer</a> &gt; <span class="el_source">ElasticSearchTwitterClient.java</span></div><h1>ElasticSearchTwitterClient.java</h1><pre class="source lang-java linenums">package com.elasticsearch.consumer;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.security.KeyManagementException;
import java.security.KeyStore;
import java.security.KeyStoreException;
import java.security.NoSuchAlgorithmException;
import java.security.cert.Certificate;
import java.security.cert.CertificateException;
import java.security.cert.CertificateFactory;
import java.util.Arrays;

import javax.net.ssl.SSLContext;

import org.apache.http.HttpHost;
import org.apache.http.auth.AuthScope;
import org.apache.http.auth.UsernamePasswordCredentials;
import org.apache.http.client.CredentialsProvider;
import org.apache.http.conn.ssl.NoopHostnameVerifier;
import org.apache.http.impl.client.BasicCredentialsProvider;
import org.apache.http.impl.nio.client.HttpAsyncClientBuilder;
import org.apache.http.ssl.SSLContextBuilder;
import org.apache.http.ssl.SSLContexts;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestClientBuilder.HttpClientConfigCallback;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import co.elastic.clients.elasticsearch.ElasticsearchClient;
import co.elastic.clients.elasticsearch._types.ElasticsearchException;
import co.elastic.clients.elasticsearch.core.IndexRequest;
import co.elastic.clients.elasticsearch.indices.Alias;
import co.elastic.clients.elasticsearch.indices.CreateIndexRequest;
import co.elastic.clients.elasticsearch.indices.CreateIndexResponse;
import co.elastic.clients.elasticsearch.indices.ExistsRequest;
import co.elastic.clients.json.jackson.JacksonJsonpMapper;
import co.elastic.clients.transport.ElasticsearchTransport;
import co.elastic.clients.transport.rest_client.RestClientTransport;

public class ElasticSearchTwitterClient {

    private ElasticsearchClient client;
    private final static String INDEX = &quot;twitter&quot;;

<span class="nc" id="L46">    Logger logger = LoggerFactory.getLogger(ElasticSearchTwitterClient.class);</span>

<span class="nc" id="L48">    public ElasticSearchTwitterClient() throws ElasticsearchException, IOException, CertificateException,</span>
            NoSuchAlgorithmException, KeyStoreException, KeyManagementException {

<span class="nc" id="L51">        String elasticHost = System.getenv(&quot;ES_HOST&quot;);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">        if (elasticHost == null)</span>
<span class="nc" id="L53">            throw new IllegalArgumentException(&quot;the ES_HOST env variable is not set&quot;);</span>
<span class="nc" id="L54">        Integer elasticPort = Integer.valueOf(System.getenv(&quot;ES_PORT&quot;));</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">        if (elasticPort == null)</span>
<span class="nc" id="L56">            throw new IllegalArgumentException(&quot;the ES_PORT env variable is not set&quot;);</span>
<span class="nc" id="L57">        String password = System.getenv(&quot;ES_PASSWORD&quot;);</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (password == null)</span>
<span class="nc" id="L59">            throw new IllegalArgumentException(&quot;the ES_PASSWORD env variable is not set&quot;);</span>
<span class="nc" id="L60">        String caCert = System.getenv(&quot;ES_CA_CRT&quot;);</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (caCert == null)</span>
<span class="nc" id="L62">            throw new IllegalArgumentException(&quot;the ES_CA_CRT env variable is not set&quot;);</span>

<span class="nc" id="L64">        final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();</span>
<span class="nc" id="L65">        credentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(&quot;elastic&quot;, password));</span>

<span class="nc" id="L67">        CertificateFactory factory = CertificateFactory.getInstance(&quot;X.509&quot;);</span>
<span class="nc" id="L68">        Certificate trustedCa = factory.generateCertificate(new ByteArrayInputStream(caCert.getBytes()));</span>
<span class="nc" id="L69">        KeyStore trustStore = KeyStore.getInstance(&quot;pkcs12&quot;);</span>
<span class="nc" id="L70">        trustStore.load(null, null);</span>
<span class="nc" id="L71">        trustStore.setCertificateEntry(&quot;ca&quot;, trustedCa);</span>
<span class="nc" id="L72">        SSLContextBuilder sslContextBuilder = SSLContexts.custom()</span>
<span class="nc" id="L73">                .loadTrustMaterial(trustStore, null);</span>
<span class="nc" id="L74">        final SSLContext sslContext = sslContextBuilder.build();</span>

        // Create the low-level client
<span class="nc" id="L77">        RestClient restClient = RestClient.builder(</span>
<span class="nc" id="L78">                new HttpHost(elasticHost, elasticPort, &quot;https&quot;))</span>
<span class="nc" id="L79">                .setHttpClientConfigCallback(new HttpClientConfigCallback() {</span>
                    @Override
                    public HttpAsyncClientBuilder customizeHttpClient(
                            HttpAsyncClientBuilder httpClientBuilder) {
<span class="nc" id="L83">                        return httpClientBuilder</span>
<span class="nc" id="L84">                                .setDefaultCredentialsProvider(credentialsProvider)</span>
<span class="nc" id="L85">                                .setSSLContext(sslContext)</span>
<span class="nc" id="L86">                                .setSSLHostnameVerifier(NoopHostnameVerifier.INSTANCE);</span>
                    }
                })
<span class="nc" id="L89">                .build();</span>

        // Create the transport with a Jackson mapper
<span class="nc" id="L92">        ElasticsearchTransport transport = new RestClientTransport(</span>
<span class="nc" id="L93">                restClient, new JacksonJsonpMapper());</span>

        // And create the API client
<span class="nc" id="L96">        client = new ElasticsearchClient(transport);</span>

<span class="nc" id="L98">        createIndex();</span>

<span class="nc" id="L100">    }</span>

    private void createIndex() throws ElasticsearchException, IOException {
<span class="nc" id="L103">        boolean indiceExsit = client.indices().exists(new ExistsRequest.Builder().index(Arrays.asList(INDEX)).build())</span>
<span class="nc" id="L104">                .value();</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (!indiceExsit) {</span>
<span class="nc" id="L106">            CreateIndexResponse createResponse = client.indices().create(</span>
<span class="nc" id="L107">                    new CreateIndexRequest.Builder()</span>
<span class="nc" id="L108">                            .index(INDEX)</span>
<span class="nc" id="L109">                            .aliases(INDEX+&quot;_alias&quot;,</span>
<span class="nc" id="L110">                                    new Alias.Builder().isWriteIndex(true).build())</span>
<span class="nc" id="L111">                            .build());</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (!createResponse.acknowledged()) {</span>
<span class="nc" id="L113">                throw new IllegalStateException(&quot;impossible to create index &quot; + INDEX);</span>
            }
        }
<span class="nc" id="L116">    }</span>

    public void pushTweet(Long id, String text) throws ElasticsearchException, IOException {
<span class="nc" id="L119">        client.index(new IndexRequest.Builder&lt;Tweet&gt;()</span>
<span class="nc" id="L120">            .id(Long.toString(id))</span>
<span class="nc" id="L121">            .index(INDEX)</span>
<span class="nc" id="L122">            .document(new Tweet(id, text))</span>
<span class="nc" id="L123">            .build());</span>
<span class="nc" id="L124">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>